-- =============================================
-- Base de Datos y Tablas para el Test Emocional Illari
-- Versión final 2025
-- Fecha: 17 de diciembre de 2025
-- =============================================

-- Opcional: Crear la base de datos (ejecutar esto solo si no existe)
-- Debes estar conectado como superusuario o con permisos suficientes
-- CREATE DATABASE illari_db
--     WITH 
--     OWNER = postgres
--     ENCODING = 'UTF8'
--     LC_COLLATE = 'es_ES.UTF-8'
--     LC_CTYPE = 'es_ES.UTF-8'
--     TEMPLATE = template0;

-- Conéctate a la base de datos creada (en pgAdmin: selecciona la BD)
-- \c illari_db

-- Asegura la extensión pgcrypto para generar UUID automáticos
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- =============================================
-- Tabla 1: resultados_test
-- Almacena los resultados anónimos de los usuarios
-- =============================================
DROP TABLE IF EXISTS resultados_test CASCADE;

CREATE TABLE resultados_test (
    id SERIAL PRIMARY KEY,
    usuario_id UUID DEFAULT gen_random_uuid() NOT NULL,
    promedio NUMERIC(3,2) NOT NULL,
    nivel VARCHAR(50) NOT NULL,
    color VARCHAR(20) NOT NULL,
    mensaje TEXT NOT NULL,
    fecha_registro TIMESTAMP WITHOUT TIME ZONE
                     DEFAULT CURRENT_TIMESTAMP NOT NULL
);

-- Índice para consultas por fecha
CREATE INDEX idx_resultados_fecha
    ON resultados_test (fecha_registro DESC);

-- Comentarios
COMMENT ON TABLE resultados_test IS 'Resultados anónimos del test emocional Illari - Decide Resplandecer';
COMMENT ON COLUMN resultados_test.usuario_id IS 'UUID anónimo del usuario (generado automáticamente)';
COMMENT ON COLUMN resultados_test.promedio IS 'Promedio calculado del test (ej: 4.75)';
COMMENT ON COLUMN resultados_test.nivel IS 'Nivel emocional asignado (ej: "Alto", "Medio")';
COMMENT ON COLUMN resultados_test.color IS 'Color asociado para visualización (ej: "verde", "rojo")';
COMMENT ON COLUMN resultados_test.mensaje IS 'Mensaje personalizado según el resultado';

-- =============================================
-- Tabla 2: categorias_resultado
-- Define los rangos de promedio y sus categorías correspondientes
-- =============================================
DROP TABLE IF EXISTS categorias_resultado CASCADE;

CREATE TABLE categorias_resultado (
    id INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    nombre CHARACTER VARYING(20) NOT NULL,
    promedio_min NUMERIC(3,2) NOT NULL,
    promedio_max NUMERIC(3,2) NOT NULL
);

-- Índices recomendados
CREATE INDEX idx_categorias_nombre 
    ON categorias_resultado (nombre);

CREATE INDEX idx_categorias_rango 
    ON categorias_resultado (promedio_min, promedio_max);

-- Comentarios
COMMENT ON TABLE categorias_resultado IS 'Categorías de resultados del test emocional Illari según rangos de promedio';
COMMENT ON COLUMN categorias_resultado.id IS 'Identificador único autoincremental (clave primaria)';
COMMENT ON COLUMN categorias_resultado.nombre IS 'Nombre de la categoría (máx. 20 caracteres, ej: "Bajo")';
COMMENT ON COLUMN categorias_resultado.promedio_min IS 'Límite inferior inclusivo del rango';
COMMENT ON COLUMN categorias_resultado.promedio_max IS 'Límite superior inclusivo del rango';

-- =============================================
-- Datos de ejemplo para categorias_resultado (opcional, para pruebas)
-- =============================================
INSERT INTO categorias_resultado (nombre, promedio_min, promedio_max) VALUES
    ('Muy Bajo', 0.00, 1.99),
    ('Bajo', 2.00, 3.49),
    ('Medio', 3.50, 4.49),
    ('Alto', 4.50, 5.00)
ON CONFLICT DO NOTHING;

-- Fin del script